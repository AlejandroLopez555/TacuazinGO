@model IEnumerable<TacuazinGO.Models.ArchivoFinanciero>

@{
    ViewData["Title"] = "Archivos Históricos TacuazinGO";
}

<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="display-4">
                <span class="text-custom-gray">📚 Archivos</span><span class="text-custom-pink">Históricos</span>
            </h1>
            <p class="lead text-muted">Consulta todos los períodos archivados del sistema</p>
        </div>
    </div>

    <!-- Botones de navegación -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="/Home/Reportes" class="btn btn-primary me-2">
                📊 Volver a Reportes
            </a>
            <a href="/" class="btn btn-outline-secondary">
                🏠 Ir al Dashboard
            </a>
        </div>
    </div>

    <!-- Tarjeta de archivos -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-custom text-white">
                    <h4 class="mb-0">📁 Períodos Archivados</h4>
                </div>
                <div class="card-body">
                    @if (Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-custom-header">
                                    <tr>
                                        <th>Nombre del Archivo</th>
                                        <th class="text-center">Fecha Archivado</th>
                                        <th class="text-end">Ventas</th>
                                        <th class="text-end">Gastos</th>
                                        <th class="text-end">Balance</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var archivo in Model)
                                    {
                                        <tr>
                                            <td>
                                                <strong>@archivo.NombreArchivo</strong>
                                                @if (!string.IsNullOrEmpty(archivo.Descripcion))
                                                {
                                                    <br>
                                                    <small class="text-muted">@archivo.Descripcion</small>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <small>@archivo.FechaArchivado.ToString("dd/MM/yyyy HH:mm")</small>
                                            </td>
                                            <td class="text-end">
                                                <span class="text-success fw-bold">$@archivo.TotalVentasArchivadas.ToString("N2")</span>
                                                <br>
                                                <small class="text-muted">@archivo.CantidadVentasArchivadas transacciones</small>
                                            </td>
                                            <td class="text-end">
                                                <span class="text-warning fw-bold">$@archivo.TotalGastosArchivados.ToString("N2")</span>
                                                <br>
                                                <small class="text-muted">@archivo.CantidadGastosArchivados registros</small>
                                            </td>
                                            <td class="text-end">
                                                @{
                                                    var balance = archivo.TotalVentasArchivadas - archivo.TotalGastosArchivados;
                                                    var balanceClass = balance >= 0 ? "text-success" : "text-danger";
                                                }
                                                <span class="fw-bold @balanceClass">$@balance.ToString("N2")</span>
                                            </td>
                                            <td class="text-center">
                                                <a href="/Home/DetallesArchivo/@archivo.Id" class="btn btn-sm btn-outline-primary">
                                                    👁️ Ver Detalles
                                                </a>
                                                <button class="btn btn-sm btn-outline-success" onclick="exportarArchivo(@archivo.Id)">
                                                    📄 Exportar
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <div class="mb-3">📁</div>
                            <h5 class="text-muted">No hay archivos históricos</h5>
                            <p class="text-muted">Los períodos archivados aparecerán aquí.</p>
                            <a href="/Home/Reportes" class="btn btn-primary mt-3">
                                📊 Ir a Reportes para Archivar
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function exportarArchivo(archivoId) {
            Swal.fire({
                title: 'Exportando Archivo',
                html: `
                    <div class="text-start">
                        <p>Selecciona el formato de exportación:</p>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="exportFormat" id="pdfFormat" value="pdf" checked>
                            <label class="form-check-label" for="pdfFormat">
                                📄 PDF - Reporte completo
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="exportFormat" id="excelFormat" value="excel">
                            <label class="form-check-label" for="excelFormat">
                                📊 Excel - Datos tabulares
                            </label>
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Exportar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const format = document.querySelector('input[name="exportFormat"]:checked')?.value;
                    return format ? { format } : Promise.reject(new Error('Selecciona un formato'));
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    generarReporteArchivo(archivoId, result.value.format);
                }
            });
        }

        function generarReporteArchivo(archivoId, formato) {
            // Mostrar loading
            Swal.fire({
                title: 'Generando Reporte',
                text: 'Preparando archivo histórico...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            if (formato === 'pdf') {
                generarPDFArchivo(archivoId);
            } else {
                // Para Excel (podemos implementar después)
                Swal.fire({
                    title: 'Función en Desarrollo',
                    text: 'La exportación a Excel estará disponible pronto',
                    icon: 'info',
                    confirmButtonText: 'Entendido'
                });
            }
        }

        function generarPDFArchivo(archivoId) {
            // Verificar librerías
            if (typeof window.jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                Swal.fire({
                    title: 'Error',
                    text: 'Las librerías de PDF no están cargadas correctamente',
                    icon: 'error',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Obtener datos del archivo específico
            fetch(`/api/VentasApi/obtener-archivo/${archivoId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al obtener datos del archivo');
                    }
                    return response.json();
                })
                .then(archivo => {
                    generarContenidoPDF(doc, archivo);
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'No se pudieron obtener los datos del archivo: ' + error.message,
                        icon: 'error',
                        confirmButtonText: 'Entendido'
                    });
                });
        }

        function generarContenidoPDF(doc, archivo) {
            try {
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let yPosition = 20;

                // Encabezado del PDF
                doc.setFontSize(20);
                doc.setTextColor(40, 167, 69);
                doc.text('TACUAZIN GO - REPORTE ARCHIVADO', pageWidth / 2, yPosition, { align: 'center' });

                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                yPosition += 10;
                doc.text(`Archivo: ${archivo.nombreArchivo}`, pageWidth / 2, yPosition, { align: 'center' });

                yPosition += 8;
                doc.text(`Generado el: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, pageWidth / 2, yPosition, { align: 'center' });

                yPosition += 15;

                // Información del archivo
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('INFORMACIÓN DEL ARCHIVO', 20, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                const infoArchivo = [
                    { label: 'Nombre del Archivo', value: archivo.nombreArchivo },
                    { label: 'Fecha de Archivado', value: new Date(archivo.fechaArchivado).toLocaleDateString('es-MX') },
                    { label: 'Descripción', value: archivo.descripcion || 'Sin descripción' },
                    { label: 'Archivado por', value: archivo.usuarioId || 'Sistema' }
                ];

                infoArchivo.forEach(item => {
                    if (yPosition > pageHeight - 40) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    doc.setTextColor(0, 0, 0);
                    doc.text(item.label + ':', 25, yPosition);
                    doc.setTextColor(80, 80, 80);
                    doc.text(item.value, 80, yPosition);
                    yPosition += 8;
                });

                yPosition += 10;

                // Resumen financiero
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('RESUMEN FINANCIERO', 20, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                const balance = archivo.totalVentasArchivadas - archivo.totalGastosArchivados;
                const rentabilidad = archivo.totalVentasArchivadas > 0 ? (balance / archivo.totalVentasArchivadas) * 100 : 0;

                const resumenData = [
                    { label: 'Total Ventas Archivadas', value: `$${archivo.totalVentasArchivadas.toFixed(2)}` },
                    { label: 'Total Gastos Archivados', value: `$${archivo.totalGastosArchivados.toFixed(2)}` },
                    { label: 'Balance del Período', value: `$${balance.toFixed(2)}` },
                    { label: 'Rentabilidad', value: `${rentabilidad.toFixed(1)}%` },
                    { label: 'Cantidad de Ventas', value: `${archivo.cantidadVentasArchivadas} transacciones` },
                    { label: 'Cantidad de Gastos', value: `${archivo.cantidadGastosArchivados} registros` }
                ];

                resumenData.forEach(item => {
                    if (yPosition > pageHeight - 40) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    doc.setTextColor(0, 0, 0);
                    doc.text(item.label, 25, yPosition);
                    doc.setTextColor(40, 167, 69);
                    doc.text(item.value, pageWidth - 25, yPosition, { align: 'right' });
                    yPosition += 8;
                });

                yPosition += 10;

                // Detalles de ventas (primeras 20)
                if (archivo.ventas && archivo.ventas.length > 0) {
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0);
                    doc.text('DETALLE DE VENTAS ARCHIVADAS', 20, yPosition);
                    yPosition += 10;

                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);

                    // Encabezado tabla ventas
                    doc.text('Fecha', 25, yPosition);
                    doc.text('Total', pageWidth - 50, yPosition, { align: 'right' });
                    doc.text('Productos', pageWidth - 20, yPosition, { align: 'right' });
                    yPosition += 5;

                    doc.line(20, yPosition, pageWidth - 20, yPosition);
                    yPosition += 8;

                    // Datos de ventas
                    archivo.ventas.slice(0, 20).forEach(venta => {
                        if (yPosition > pageHeight - 20) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        const fecha = new Date(venta.fecha).toLocaleDateString();
                        doc.setTextColor(0, 0, 0);
                        doc.text(fecha, 25, yPosition);
                        doc.text(`$${venta.total.toFixed(2)}`, pageWidth - 50, yPosition, { align: 'right' });
                        doc.text(venta.cantidadProductos.toString(), pageWidth - 20, yPosition, { align: 'right' });
                        yPosition += 6;
                    });

                    if (archivo.ventas.length > 20) {
                        yPosition += 5;
                        doc.setTextColor(100, 100, 100);
                        doc.text(`... y ${archivo.ventas.length - 20} ventas más`, 25, yPosition);
                        yPosition += 8;
                    }
                }

                // Pie de página
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('Reporte generado automáticamente por TacuazinGO - Sistema de Gestión',
                        pageWidth / 2, pageHeight - 10, { align: 'center' });

                // Finalizar y descargar
                setTimeout(() => {
                    const nombreArchivo = `Archivo_${archivo.nombreArchivo.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(nombreArchivo);

                    Swal.fire({
                        title: 'PDF Generado',
                        text: 'El reporte del archivo se ha descargado exitosamente',
                        icon: 'success',
                        confirmButtonText: 'Perfecto'
                    });
                }, 1000);

            } catch (error) {
                console.error('Error generando PDF:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Ocurrió un error al generar el PDF: ' + error.message,
                    icon: 'error',
                    confirmButtonText: 'Entendido'
                });
            }
        }

        // Efectos hover en las filas - ESTA FUNCIÓN ESTABA FUERA
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                row.style.transition = 'all 0.3s ease';
                row.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                });
            });
        });
    </script>
}